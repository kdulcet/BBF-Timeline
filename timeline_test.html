<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JourneyMap Timeline - Phase 1 Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        
        .timeline-controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .timeline-status {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        
        .hz-display {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
            text-align: center;
            margin: 10px 0;
        }
        
        .wave-type {
            text-align: center;
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        .pulse-flash {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff4444;
            display: inline-block;
            margin: 0 10px;
            transition: opacity 0.1s;
        }
        
        .pulse-flash.active {
            background: #44ff44;
            box-shadow: 0 0 10px #44ff44;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .event-log {
            background: #222;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .segment-config {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        input[type="number"] {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px;
            border-radius: 4px;
            width: 80px;
        }
    </style>
</head>
<body>
    <h1>JourneyMap Timeline - Phase 1 Test</h1>
    
    <!-- Timeline Controls -->
    <div class="timeline-controls">
        <h3>Timeline Controls</h3>
        <button id="startBtn">Start Timeline</button>
        <button id="pauseBtn" disabled>Pause Timeline</button>
        <button id="stopBtn" disabled>Stop Timeline</button>
    </div>
    
    <!-- Timeline Status -->
    <div class="timeline-status">
        <h3>Timeline Status</h3>
        <div class="hz-display" id="hzDisplay">0.0 Hz</div>
        <div class="wave-type" id="waveType">UNKNOWN</div>
        <div>
            <span>32n Pulse:</span>
            <span class="pulse-flash" id="pulseFlash"></span>
            <span id="pulseCount">0 pulses</span>
        </div>
        <div id="timelinePosition">Position: 0.0s</div>
        <div id="currentSegment">Segment: None</div>
    </div>
    
    <!-- Segment Configuration -->
    <div class="segment-config">
        <h3>Timeline Configuration</h3>
        <div>
            <label>Beta Plateau Hz: <input type="number" id="betaHz" value="15" min="0.5" max="25" step="0.1"></label>
            <label>Duration (min): <input type="number" id="betaDuration" value="2" min="0.1" max="30" step="0.1"></label>
        </div>
        <div>
            <label>Alpha Plateau Hz: <input type="number" id="alphaHz" value="10" min="0.5" max="25" step="0.1"></label>
            <label>Duration (min): <input type="number" id="alphaDuration" value="3" min="0.1" max="30" step="0.1"></label>
        </div>
        <button id="updateTimelineBtn">Update Timeline</button>
    </div>
    
    <!-- Event Log -->
    <div>
        <h3>Timeline Events Log</h3>
        <div class="event-log" id="eventLog"></div>
        <button id="clearLogBtn">Clear Log</button>
    </div>

    <!-- Load Timeline Classes -->
    <script src="widgets/synths/shared/timeline.js"></script>
    <script src="widgets/synths/shared/state_timeline.js"></script>
    <script src="widgets/synths/shared/jm_timeline.js"></script>
    <script src="widgets/synths/shared/timeline_integration.js"></script>

    <script>
        // Global variables
        let audioContext;
        let timeline;
        let testSynth;
        let pulseCount = 0;
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const hzDisplay = document.getElementById('hzDisplay');
        const waveType = document.getElementById('waveType');
        const pulseFlash = document.getElementById('pulseFlash');
        const pulseCountDisplay = document.getElementById('pulseCount');
        const timelinePosition = document.getElementById('timelinePosition');
        const currentSegment = document.getElementById('currentSegment');
        const eventLog = document.getElementById('eventLog');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const updateTimelineBtn = document.getElementById('updateTimelineBtn');
        
        // Test synth class using dual band integration
        class TestSynth extends DualBandListener {
            constructor(audioContext) {
                super(audioContext, {
                    autoStart: true,
                    autoStop: true,
                    waveBand: {
                        hzUpdateRate: 'realtime',
                        smoothTransitions: true
                    },
                    pulseBand: {
                        pulseAccuracy: 'sample',
                        enablePulseFlash: true
                    }
                });
                
                this.name = "TestSynth";
            }
            
            onTimelineStart(detail) {
                this.logEvent('Timeline Started', detail);
            }
            
            onTimelineStop(detail) {
                this.logEvent('Timeline Stopped', detail);
            }
            
            onTimelinePause(detail) {
                this.logEvent('Timeline Paused', detail);
            }
            
            onWaveBandHz(hz, time, waveType) {
                hzDisplay.textContent = `${hz.toFixed(1)} Hz`;
                waveType.textContent = waveType;
                this.logEvent('Hz Changed', { hz, waveType });
            }
            
            onWaveBandTransition(fromHz, toHz, duration, startTime) {
                this.logEvent('Transition Started', { fromHz, toHz, duration });
            }
            
            onPulseBand32n(time, hz, interval, pulseCount) {
                // Flash the pulse indicator
                pulseFlash.classList.add('active');
                setTimeout(() => {
                    pulseFlash.classList.remove('active');
                }, 50);
                
                pulseCountDisplay.textContent = `${pulseCount} pulses`;
                this.logEvent('32n Pulse', { pulseCount, interval: interval.toFixed(3) });
            }
            
            onPulseBandRateChanged(hz, interval, time) {
                this.logEvent('Pulse Rate Changed', { hz, interval: interval.toFixed(3) });
            }
            
            logEvent(eventName, data) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${this.name}: ${eventName} ${JSON.stringify(data)}`;
                
                const logDiv = document.createElement('div');
                logDiv.textContent = logEntry;
                eventLog.appendChild(logDiv);
                eventLog.scrollTop = eventLog.scrollHeight;
            }
        }
        
        // Initialize audio context and timeline
        async function initializeTimeline() {
            try {
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create initial timeline segments
                const segments = createTimelineSegments();
                
                // Create timeline
                timeline = new JMTimeline(audioContext, segments);
                
                // Create test synth
                testSynth = new TestSynth(audioContext);
                testSynth.startListening();
                
                // Setup visual feedback
                setupVisualFeedback();
                
                console.log('Timeline initialized successfully');
                logToEventLog('System', 'Timeline initialized', { segments: segments.length });
                
            } catch (error) {
                console.error('Failed to initialize timeline:', error);
                logToEventLog('System', 'Initialization failed', { error: error.message });
            }
        }
        
        // Create timeline segments from form inputs
        function createTimelineSegments() {
            const betaHz = parseFloat(document.getElementById('betaHz').value);
            const betaDuration = parseFloat(document.getElementById('betaDuration').value);
            const alphaHz = parseFloat(document.getElementById('alphaHz').value);
            const alphaDuration = parseFloat(document.getElementById('alphaDuration').value);
            
            return [
                {
                    type: 'plateau',
                    hz: betaHz,
                    durationSeconds: betaDuration * 60 // Convert minutes to seconds
                },
                {
                    type: 'transition',
                    startHz: betaHz,
                    endHz: alphaHz,
                    durationSeconds: 30, // 30 second transition
                    transitionType: 'linear'
                },
                {
                    type: 'plateau',
                    hz: alphaHz,
                    durationSeconds: alphaDuration * 60 // Convert minutes to seconds
                }
            ];
        }
        
        // Setup visual feedback loop
        function setupVisualFeedback() {
            function updateDisplay() {
                if (timeline && timeline.isRunning) {
                    const state = timeline.getCurrentState();
                    if (state) {
                        timelinePosition.textContent = `Position: ${state.position.toFixed(1)}s`;
                        currentSegment.textContent = `Segment: ${state.segmentIndex} (${state.segment?.type || 'none'})`;
                    }
                }
                requestAnimationFrame(updateDisplay);
            }
            updateDisplay();
        }
        
        // Event handlers
        startBtn.addEventListener('click', async () => {
            if (!audioContext) {
                await initializeTimeline();
            }
            
            // Resume audio context if suspended
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
            
            timeline.start();
            
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            stopBtn.disabled = false;
        });
        
        pauseBtn.addEventListener('click', () => {
            timeline.pause();
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = false;
        });
        
        stopBtn.addEventListener('click', () => {
            timeline.stop();
            pulseCount = 0;
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            
            // Reset displays
            hzDisplay.textContent = '0.0 Hz';
            waveType.textContent = 'UNKNOWN';
            pulseCountDisplay.textContent = '0 pulses';
            timelinePosition.textContent = 'Position: 0.0s';
            currentSegment.textContent = 'Segment: None';
        });
        
        updateTimelineBtn.addEventListener('click', async () => {
            if (timeline && timeline.isRunning) {
                timeline.stop();
            }
            
            // Create new timeline with updated segments
            const segments = createTimelineSegments();
            timeline = new JMTimeline(audioContext, segments);
            
            logToEventLog('System', 'Timeline updated', { segments: segments.length });
            
            // Reset UI
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
        });
        
        clearLogBtn.addEventListener('click', () => {
            eventLog.innerHTML = '';
        });
        
        // Helper function to log system events
        function logToEventLog(source, message, data = {}) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${source}: ${message} ${JSON.stringify(data)}`;
            
            const logDiv = document.createElement('div');
            logDiv.textContent = logEntry;
            eventLog.appendChild(logDiv);
            eventLog.scrollTop = eventLog.scrollHeight;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('JourneyMap Timeline Phase 1 Test Ready');
            logToEventLog('System', 'Page loaded', { ready: true });
        });
    </script>
</body>
</html>